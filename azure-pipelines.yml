# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript


trigger:
  branches:
    include:
    - main
    - refs/tags/*
    - releases/tags/*
    - azure-pipeline

pr:
- main
- azure-pipeline

pool:
  vmImage: 'ubuntu-latest'

stages:
  - stage: 'InstallOS'
    jobs:
    - job: "InstallOS"
      steps:
      - task: NodeTool@0
        inputs:
          versionSpec: '10.x'
        displayName: 'Install Node.js'
  - stage: 'BuildFrontEnd'
    jobs:
    - template: '.pipeline/job_check_changes.yml'
      parameters:
        path: 'frontend/'
    - template: '.pipeline/job_enforce_standards.yml'
      parameters:
        path: 'frontend/'
  - stage: 'BuildBackEnd'
    jobs:
    - template: '.pipeline/job_check_changes.yml'
      parameters:
        path: 'backend/'
    - template: '.pipeline/job_enforce_standards.yml'
      parameters:
        path: 'frontend/'    
  - stage: 'DockerBuildAndPush'
    jobs:
    - job: RefTags
      condition: startsWith(variables['build.sourceBranch'], 'refs/tags/v')
      steps:
      - bash: |
          echo Building Docker Image for tag "$(build.sourceBranchName)"
      - task: Docker@2
        displayName: Login to DockerHub
        inputs:
          command: login
          containerRegistry: "NicoAndra DockerHub"
      - task: Docker@2
        displayName: Build and Push
        inputs:
          command: buildAndPush
          repository: nicoandra/s3-browser
          tags: |
            $(build.sourceBranchName)
      - task: Docker@2
        displayName: Logout from DockerHub
        inputs:
          command: logout
          containerRegistry: "NicoAndra DockerHub"
